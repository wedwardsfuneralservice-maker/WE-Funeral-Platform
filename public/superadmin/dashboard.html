<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Super Admin Dashboard ‚Äì WE Funeral Platform</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ===========================
       GLOBAL STYLES + THEMES
  ============================ -->
  <style>
    :root {
      /* Gradient Theme */
      --blue-royal: #306cde;
      --navy: #1e3a8a;

      /* Feature Toggle Colors */
      --green: #16a34a;
      --red: #dc2626;

      /* Light Theme */
      --bg-light: #f9fafb;
      --card-light: #ffffff;
      --text-light: #0f172a;
      --text-light-muted: #6b7280;

      /* Dark Theme */
      --bg-dark: #0d0f12;
      --card-dark: #171a22;
      --text-dark: #f9fafb;
      --text-dark-muted: #9ca3af;

      --radius-lg: 16px;
      --radius-md: 10px;
      --shadow-soft: 0 18px 35px rgba(0, 0, 0, 0.45);
    }

    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      display: flex;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ============================================
       THEME CONTEXT
    ============================================ */

    body.theme-dark {
      background:
        radial-gradient(circle at top left, rgba(48,108,222,0.18), transparent 60%),
        linear-gradient(140deg, #020617, #0b0d12, #020617);
      color: var(--text-dark);
    }

    body.theme-light {
      background: var(--bg-light);
      color: var(--text-light);
    }

    /* ============================================
       SIDEBAR
    ============================================ */
    .sidebar {
      width: 260px;
      padding: 24px 20px;
      display: flex;
      flex-direction: column;
      gap: 30px;
    }

    body.theme-dark .sidebar {
      background: linear-gradient(180deg, #05060a, #0b0d12 40%, #05060a 100%);
      border-right: 1px solid rgba(148,163,184,0.25);
      box-shadow: 18px 0 40px rgba(0,0,0,0.45);
    }

    body.theme-light .sidebar {
      background: #ffffff;
      border-right: 1px solid rgba(148,163,184,0.3);
      box-shadow: 12px 0 30px rgba(0,0,0,0.1);
    }

    .brand-title {
      font-size: 18px;
      letter-spacing: 0.14em;
      font-weight: 700;
      text-transform: uppercase;
      background: linear-gradient(90deg, var(--navy), var(--blue-royal));
      -webkit-background-clip: text;
      color: transparent;
    }

    .nav-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .nav-item {
      padding: 10px 14px;
      border-radius: 999px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: 0.15s ease;
      font-size: 14px;
    }

    body.theme-dark .nav-item { color: var(--text-dark-muted); }
    body.theme-light .nav-item { color: var(--text-light-muted); }

    .nav-item.active {
      background: linear-gradient(90deg, var(--navy), var(--blue-royal));
      color: white;
      box-shadow: 0 0 0 1px rgba(147,197,253,0.4);
    }

    .nav-item:hover {
      transform: translateX(2px);
    }

    /* ============================================
       MAIN AREA
    ============================================ */
    .main {
      flex: 1;
      padding: 24px 28px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .pill-button {
      padding: 8px 14px;
      border-radius: 999px;
      cursor: pointer;
      border: none;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: 0.2s;
    }

    .pill-button.primary {
      background: linear-gradient(90deg, var(--navy), var(--blue-royal));
      color: white;
    }

    .search-box {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 13px;
    }

    body.theme-dark .search-box {
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.35);
      color: white;
    }

    body.theme-light .search-box {
      background: white;
      border: 1px solid rgba(148,163,184,0.35);
      color: #111;
    }

    /* ============================================
       STATS CARDS
    ============================================ */
    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
    }

    .card {
      padding: 16px;
      border-radius: var(--radius-lg);
      box-sizing: border-box;
    }

    body.theme-dark .card {
      background: linear-gradient(145deg, #0b1020, #111827);
      border: 1px solid rgba(148,163,184,0.25);
      box-shadow: var(--shadow-soft);
      color: white;
    }

    body.theme-light .card {
      background: white;
      border: 1px solid rgba(148,163,184,0.25);
      color: #111;
    }

    /* ============================================
       TENANT TABLE
    ============================================ */
    table.tenant-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    table.tenant-table th,
    table.tenant-table td {
      padding: 10px 6px;
      border-bottom: 1px solid rgba(148,163,184,0.3);
      text-align: left;
    }

    .manage-btn {
      padding: 6px 12px;
      background: linear-gradient(90deg, var(--navy), var(--blue-royal));
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
    }

    /* ============================================
       CREATE TENANT MODAL
    ============================================ */
    #createTenantModal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.55);
      z-index: 500;
    }

    .modal-box {
      background: #111827;
      padding: 24px;
      width: 420px;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.35);
      box-shadow: 0 18px 45px rgba(0,0,0,0.6);
      color: white;
    }

    /* ============================================
       TENANT DRAWER + BLUR OVERLAY
    ============================================ */
    #drawerOverlay {
      position: fixed;
      inset: 0;
      backdrop-filter: blur(8px);
      background: rgba(0,0,0,0.35);
      display: none;
      z-index: 800;
    }

    #tenantDrawer {
      position: fixed;
      top: 0;
      right: -500px;
      width: 420px;
      height: 100vh;
      background: linear-gradient(135deg, #0c111b, #07101e);
      color: white;
      border-left: 1px solid rgba(148,163,184,0.35);
      box-shadow: -8px 0 25px rgba(0,0,0,0.5);
      padding: 22px;
      box-sizing: border-box;
      transition: right 0.35s ease;
      z-index: 900;
      overflow-y: auto;
    }

    #tenantDrawer.open {
      right: 0;
    }

    .drawer-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 14px;
    }

    .toggle-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 10px 0;
      padding: 10px;
      border-radius: 10px;
      background: rgba(255,255,255,0.05);
    }

    .toggle-switch {
      width: 45px;
      height: 22px;
      border-radius: 999px;
      background: #444;
      position: relative;
      cursor: pointer;
    }

    .toggle-switch .knob {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 999px;
      transition: 0.2s;
    }

    .toggle-switch.active {
      background: var(--green);
    }

    .toggle-switch.active .knob {
      left: 25px;
    }
  </style>
</head>

<body class="theme-dark">

<div class="shell">
  <!-- ===========================
       SIDEBAR
  ============================ -->
  <aside class="sidebar">
    <div>
      <div class="brand-title">W.E. PLATFORM</div>
      <div class="brand-sub" style="font-size:12px;opacity:0.7;">Super Admin Console</div>
    </div>

    <ul class="nav-list">
      <li class="nav-item active" data-view="dashboard">Dashboard</li>
      <li class="nav-item" data-view="tenants">Tenants</li>
    </ul>

    <div class="sidebar-footer" style="margin-top:auto; font-size:12px; opacity:0.7;">
      W.E. Funeral Platform ¬© <span id="yearSpan"></span>
    </div>
  </aside>

  <!-- ===========================
       MAIN CONTENT
  ============================ -->
  <main class="main">
    
    <header class="topbar">
      <div>
        <div class="page-title" style="font-size:22px;font-weight:600;">Super Admin Dashboard</div>
        <div class="page-subtitle" style="font-size:13px;opacity:0.7;">
          Monitor all funeral home tenants and platform activity.
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:12px;">
        <div class="search-box">
          üîç <input id="searchInput" type="text" placeholder="Search tenants..." style="background:transparent;border:none;outline:none;color:inherit;">
        </div>

        <button class="pill-button primary" id="createTenantBtn">+ Create Tenant</button>

        <div id="themeToggle" style="width:42px;height:22px;border-radius:999px;border:1px solid rgba(148,163,184,0.6);cursor:pointer;position:relative;">
          <div class="theme-toggle-knob" style="position:absolute;top:2px;left:20px;width:16px;height:16px;border-radius:999px;background:white;transition:0.18s;"></div>
        </div>
      </div>
    </header>

    <!-- ===========================
         STATS CARDS
    ============================ -->
    <section class="grid" id="statsGrid">
      <article class="card">
        <div class="card-label" style="opacity:0.7;font-size:12px;">Total Tenants</div>
        <div class="card-value" id="statTotalTenants" style="font-size:22px;font-weight:600;">0</div>
      </article>

      <article class="card">
        <div class="card-label">Active</div>
        <div class="card-value" id="statActiveTenants">0</div>
      </article>

      <article class="card">
        <div class="card-label">Trial</div>
        <div class="card-value" id="statTrialTenants">0</div>
      </article>

      <article class="card">
        <div class="card-label">Suspended</div>
        <div class="card-value" id="statSuspendedTenants">0</div>
      </article>
    </section>

    <!-- ===========================
         TENANT TABLE
    ============================ -->
    <section>
      <h2 style="font-size:18px;margin-bottom:10px;">Tenants</h2>
      <table class="tenant-table">
        <thead>
          <tr>
            <th>Slug</th>
            <th>Funeral Home</th>
            <th>Email</th>
            <th>Created</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tenantTable"></tbody>
      </table>
    </section>
  </main>
</div>

<!-- ===========================
     CREATE TENANT MODAL
=========================== -->
<div id="createTenantModal">
  <div class="modal-box">
    <h2>Create New Tenant</h2>

    <label>Funeral Home Name</label>
    <input id="tenantNameInput" type="text" style="width:100%;padding:10px;margin-bottom:10px;">

    <label>Slug</label>
    <input id="tenantSlugInput" type="text" style="width:100%;padding:10px;margin-bottom:10px;">

    <label>Email</label>
    <input id="tenantEmailInput" type="email" style="width:100%;padding:10px;margin-bottom:10px;">

    <label>Admin Key</label>
    <input id="tenantKeyInput" type="text" style="width:100%;padding:10px;margin-bottom:10px;">

    <button id="confirmCreateTenant" class="pill-button primary" style="width:100%;margin-top:10px;">Create Tenant</button>
    <button id="cancelCreateTenant" class="pill-button secondary" style="width:100%;margin-top:10px;background:#334155;color:white;">Cancel</button>
  </div>
</div>

<!-- ===========================
     TENANT MANAGEMENT DRAWER
=========================== -->
<div id="drawerOverlay"></div>

<div id="tenantDrawer">

  <div class="drawer-title">Manage Tenant</div>

  <label style="font-size:14px;">Funeral Home Name</label>
  <input id="drawerName" type="text" style="width:100%;padding:10px;margin-bottom:10px;border-radius:10px;background:#0f172a;border:1px solid #334155;color:white;">

  <label>Email</label>
  <input id="drawerEmail" type="email" style="width:100%;padding:10px;margin-bottom:10px;border-radius:10px;background:#0f172a;border:1px solid #334155;color:white;">

  <label>Logo URL</label>
  <input id="drawerLogo" type="text" style="width:100%;padding:10px;margin-bottom:10px;border-radius:10px;background:#0f172a;border:1px solid #334155;color:white;">

  <label>Brand Color</label>
  <input id="drawerColor" type="color" style="width:100%;height:45px;border-radius:8px;margin-bottom:20px;">

  <h3 style="margin-top:20px;">Features</h3>

  <!-- FEATURES WILL BE POPULATED BY JS -->

  <div id="featureList"></div>

  <button id="saveTenantBtn" class="pill-button primary" style="width:100%;margin-top:20px;">Save Changes</button>
  <button id="closeDrawerBtn" class="pill-button secondary" style="width:100%;margin-top:10px;">Close</button>

</div>
<script>
/* =======================================================
   GLOBAL STATE
======================================================= */
let tenants = [];
let currentTenantSlug = null;
let drawerOpen = false;
let unsavedChanges = false;

const FEATURES = [
  "Memorial Pages",
  "Condolence Messages",
  "Funeral Intake Form",
  "Hymn Sheet Designer",
  "Appointment Scheduler",
  "PDF Auto-Fill",
  "Accounting & Payments",
  "Inventory Tracking",
  "Staff Management",
  "Analytics Dashboard"
];

/* =======================================================
   ON PAGE LOAD
======================================================= */
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("yearSpan").textContent = new Date().getFullYear();

  const token = localStorage.getItem("superadminToken");
  if (!token) {
    window.location.href = "/superadmin/login.html";
    return;
  }

  loadTenants(token);
  setupCreateTenantModal(token);
  setupThemeToggle();
  setupDrawerEvents(token);
});

/* =======================================================
   LOAD TENANTS
======================================================= */
async function loadTenants(token) {
  try {
    const res = await fetch("/superadmin/api/tenants", {
      headers: { "Authorization": "Bearer " + token }
    });
    const data = await res.json();

    if (!data.success) {
      console.error("Failed:", data.error);
      return;
    }

    tenants = data.tenants || [];
    renderTenantTable();
    updateStats();

  } catch (err) {
    console.error("Load tenants error:", err);
  }
}

/* =======================================================
   RENDER TENANT TABLE
======================================================= */
function renderTenantTable() {
  const tbody = document.getElementById("tenantTable");
  tbody.innerHTML = "";

  tenants.forEach(t => {
    const row = document.createElement("tr");

    row.innerHTML = `
      <td>${t.slug}</td>
      <td>${t.funeralHomeName}</td>
      <td>${t.email}</td>
      <td>${t.createdAt ? new Date(t.createdAt).toLocaleDateString() : "-"}</td>
      <td><span class="status-pill status-${t.status}">${t.status}</span></td>
      <td><button class="manage-btn" data-slug="${t.slug}">Manage</button></td>
    `;

    row.querySelector(".manage-btn").addEventListener("click", () => {
      openDrawer(t.slug);
    });

    tbody.appendChild(row);
  });
}

/* =======================================================
   UPDATE STATS
======================================================= */
function updateStats() {
  document.getElementById("statTotalTenants").textContent = tenants.length;
  document.getElementById("statActiveTenants").textContent =
    tenants.filter(t => t.status === "active").length;
  document.getElementById("statTrialTenants").textContent =
    tenants.filter(t => t.status === "trial").length;
  document.getElementById("statSuspendedTenants").textContent =
    tenants.filter(t => t.status === "suspended").length;
}

/* =======================================================
   CREATE TENANT MODAL LOGIC
======================================================= */
function setupCreateTenantModal(token) {
  const modal = document.getElementById("createTenantModal");
  const btnOpen = document.getElementById("createTenantBtn");
  const btnClose = document.getElementById("cancelCreateTenant");
  const btnCreate = document.getElementById("confirmCreateTenant");

  btnOpen.addEventListener("click", () => {
    modal.style.display = "flex";
    document.getElementById("tenantKeyInput").value =
      "KEY-" + Math.random().toString(36).substring(2, 10).toUpperCase();
  });

  btnClose.addEventListener("click", () => {
    modal.style.display = "none";
  });

  document.getElementById("tenantNameInput").addEventListener("input", e => {
    const slug = e.target.value
      .trim()
      .toLowerCase()
      .replace(/\s+/g, "-")
      .replace(/[^a-z0-9-]/g, "");
    document.getElementById("tenantSlugInput").value = slug;
  });

  btnCreate.addEventListener("click", async () => {
    const name = tenantNameInput.value.trim();
    const slug = tenantSlugInput.value.trim();
    const email = tenantEmailInput.value.trim();
    const adminKey = tenantKeyInput.value.trim();

    if (!name || !slug || !email || !adminKey) {
      alert("All fields required.");
      return;
    }

    const res = await fetch("/superadmin/api/tenants", {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        funeralHomeName: name,
        slug,
        email,
        adminKey,
        status: "active"
      })
    });

    const data = await res.json();
    if (data.success) {
      alert("Tenant created!");
      modal.style.display = "none";
      loadTenants(token);
    } else {
      alert("Error: " + data.error);
    }
  });
}

/* =======================================================
   DRAWER: OPEN / LOAD DATA
======================================================= */
function openDrawer(slug) {
  currentTenantSlug = slug;
  const drawer = document.getElementById("tenantDrawer");
  const overlay = document.getElementById("drawerOverlay");

  const tenant = tenants.find(t => t.slug === slug);
  if (!tenant) return;

  drawerOpen = true;
  unsavedChanges = false;

  // Fill fields
  drawerName.value  = tenant.funeralHomeName || "";
  drawerEmail.value = tenant.email || "";
  drawerLogo.value  = tenant.logo || "";
  drawerColor.value = tenant.brandColor || "#306cde";

  // Build feature toggles
  const list = document.getElementById("featureList");
  list.innerHTML = "";

  FEATURES.forEach(feat => {
    const row = document.createElement("div");
    row.className = "toggle-row";

    const isActive = tenant.features?.[feat] === true;

    row.innerHTML = `
      <span>${feat}</span>
      <div class="toggle-switch ${isActive ? "active" : ""}" data-feature="${feat}">
        <div class="knob"></div>
      </div>
    `;

    row.querySelector(".toggle-switch").addEventListener("click", e => {
      e.currentTarget.classList.toggle("active");
      unsavedChanges = true;
    });

    list.appendChild(row);
  });

  overlay.style.display = "block";
  setTimeout(() => drawer.classList.add("open"), 10);
}

/* =======================================================
   DRAWER CLOSE + UNSAVED PROTECTION
======================================================= */
function closeDrawer(force = false) {
  if (!force && unsavedChanges) {
    if (!confirm("You have unsaved changes. Close anyway?")) return;
  }

  const drawer = document.getElementById("tenantDrawer");
  const overlay = document.getElementById("drawerOverlay");

  drawer.classList.remove("open");
  setTimeout(() => overlay.style.display = "none", 300);

  drawerOpen = false;
  unsavedChanges = false;
}

/* Overlay click closes drawer */
document.getElementById("drawerOverlay").addEventListener("click", () => {
  if (drawerOpen) closeDrawer();
});

/* Close button */
document.getElementById("closeDrawerBtn").addEventListener("click", () => {
  closeDrawer();
});

/* Mark unsaved changes on input */
["drawerName", "drawerEmail", "drawerLogo", "drawerColor"].forEach(id => {
  document.getElementById(id).addEventListener("input", () => {
    unsavedChanges = true;
  });
});

/* =======================================================
   SAVE TENANT CHANGES
======================================================= */
document.getElementById("saveTenantBtn").addEventListener("click", async () => {
  if (!currentTenantSlug) return;

  const token = localStorage.getItem("superadminToken");

  // Collect feature states
  const featureStates = {};
  document.querySelectorAll(".toggle-switch").forEach(sw => {
    featureStates[sw.dataset.feature] = sw.classList.contains("active");
  });

  const payload = {
    funeralHomeName: drawerName.value.trim(),
    email: drawerEmail.value.trim(),
    logo: drawerLogo.value.trim(),
    brandColor: drawerColor.value,
    features: featureStates
  };

  const res = await fetch(`/superadmin/api/tenant/${currentTenantSlug}`, {
    method: "PUT",
    headers: {
      "Authorization": "Bearer " + token,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(payload)
  });

  const data = await res.json();

  if (data.success) {
    alert("Saved!");
    closeDrawer(true);
    loadTenants(token);
  } else {
    alert("Error saving: " + data.error);
  }
});

/* =======================================================
   THEME TOGGLE (Dark / Light)
======================================================= */
function setupThemeToggle() {
  const toggle = document.getElementById("themeToggle");
  const knob = toggle.querySelector(".theme-toggle-knob");

  let theme = localStorage.getItem("theme") || "dark";
  document.body.className = "theme-" + theme;
  knob.style.left = theme === "dark" ? "20px" : "2px";

  toggle.addEventListener("click", () => {
    theme = theme === "dark" ? "light" : "dark";
    document.body.className = "theme-" + theme;
    localStorage.setItem("theme", theme);
    knob.style.left = theme === "dark" ? "20px" : "2px";
  });
}

</script>
