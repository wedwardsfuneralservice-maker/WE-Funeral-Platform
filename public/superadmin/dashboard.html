<script>
// SAFE TOKEN LOADER — retries before redirecting
function getTokenSafely(maxRetries = 10) {
    return new Promise((resolve) => {
        let attempts = 0;

        function check() {
            const token = localStorage.getItem("superadminToken");
            if (token) return resolve(token);

            attempts++;
            if (attempts >= maxRetries) return resolve(null);

            setTimeout(check, 120); // wait 120ms then re-check
        }

        check();
    });
}

async function initDashboard() {
    const token = await getTokenSafely();

    // If still no token after retries → redirect
    if (!token) {
        console.warn("No token found — redirecting to login.");
        window.location.href = "/superadmin/login";
        return;
    }

    loadTenants(token);
}

// Load tenants from backend using token
async function loadTenants(token) {
    try {
        const res = await fetch("/superadmin/api/tenants", {
            headers: {
                "Authorization": "Bearer " + token
            }
        });

        if (!res.ok) {
            // Token expired or invalid
            console.warn("Token rejected — clearing token and redirecting.");
            localStorage.removeItem("superadminToken");
            window.location.href = "/superadmin/login";
            return;
        }

        const tenants = await res.json();
        const table = document.getElementById("tenantTable");
        table.innerHTML = "";

        tenants.forEach(t => {
            const row = document.createElement("tr");

            row.innerHTML = `
                <td>${t.slug}</td>
                <td>${t.funeralHomeName || "-"}</td>
                <td>${t.email || "-"}</td>
                <td>${new Date(t.createdAt).toLocaleDateString()}</td>
                <td>${t.status || "active"}</td>
            `;

            table.appendChild(row);
        });

    } catch (err) {
        console.error("Fetch error:", err);
    }
}

initDashboard();
</script>
