<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Funeral Home – Tenant View</title>

  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">

  <!-- Header -->
  <header class="border-b border-slate-800 bg-slate-950/80 backdrop-blur">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
      <div>
        <div class="text-xs uppercase tracking-[0.25em] text-amber-300/70">
          In loving memory
        </div>
        <h1 id="tenantName" class="text-2xl font-semibold mt-1">
          Recent memorials
        </h1>
        <p class="text-sm text-slate-400">
          View online memorials, service information, and livestream details.
        </p>
      </div>

      <a href="/" class="text-xs px-4 py-2 rounded-full border border-slate-700 hover:border-amber-300 transition">
        Back to W.E. Platform
      </a>
    </div>
  </header>

  <!-- Memorial list -->
  <main class="max-w-5xl mx-auto px-4 py-8">
    <section>
      <h2 class="text-lg font-semibold mb-4">Recent Memorials</h2>

      <div id="memorialList" class="grid gap-4 md:grid-cols-2">
        <!-- Cards injected here -->
      </div>

      <p id="emptyState" class="text-sm text-slate-400 mt-4 hidden">
        No memorials have been published yet.
      </p>
    </section>
  </main>

<script>
  const pathParts = window.location.pathname.split("/").filter(Boolean);
  const tenantSlug = pathParts[pathParts.length - 1]; // /t/w-edwards -> "w-edwards"

  async function loadTenant() {
    try {
      const res = await fetch(`/api/tenant/${tenantSlug}`);
      if (!res.ok) return;
      const tenant = await res.json();
      document.getElementById("tenantName").textContent =
        `Recent memorials for ${tenant.name}`;
    } catch (err) {
      console.error("Tenant load error", err);
    }
  }

  function formatDate(d) {
    if (!d) return "";
    return new Date(d).toLocaleDateString();
  }

  async function loadMemorials() {
    const listEl = document.getElementById("memorialList");
    const emptyEl = document.getElementById("emptyState");
    listEl.innerHTML = "";

    try {
      const res = await fetch(`/api/memorials/${tenantSlug}`);
      const memorials = await res.json();

      if (!Array.isArray(memorials) || memorials.length === 0) {
        emptyEl.classList.remove("hidden");
        return;
      }

      emptyEl.classList.add("hidden");

      memorials
        .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0))
        .forEach((m) => {
          const card = document.createElement("article");
          card.className =
            "rounded-2xl border border-slate-800 bg-slate-900/70 p-4 flex flex-col justify-between shadow-lg";

          const serviceLabel = m.serviceDate
            ? `${formatDate(m.serviceDate)} • ${m.serviceTime || ""}`
            : "";

          card.innerHTML = `
            <div>
              <h3 class="text-lg font-semibold text-amber-200">${m.fullName || "Unnamed memorial"}</h3>
              <p class="text-xs text-slate-400 mt-1">${m.summary || ""}</p>

              ${
                m.dateOfBirth || m.dateOfDeath
                  ? `<p class="text-xs text-slate-400 mt-2">
                       ${m.dateOfBirth || "?"} – ${m.dateOfDeath || "?"}
                     </p>`
                  : ""
              }

              ${
                serviceLabel
                  ? `<p class="text-xs text-slate-300 mt-2">
                       Service: ${serviceLabel}<br/>
                       ${m.serviceLocation || ""}
                     </p>`
                  : ""
              }
            </div>

            <div class="mt-4 flex items-center justify-between gap-2">
              <a
                href="/public/memorial.html?tenant=${encodeURIComponent(
                  tenantSlug
                )}&id=${encodeURIComponent(m.id)}"
                class="text-xs px-3 py-2 rounded-full bg-amber-400 text-black font-semibold hover:bg-amber-300 transition">
                View memorial
              </a>
            </div>
          `;

          listEl.appendChild(card);
        });
    } catch (err) {
      console.error("Memorial load error", err);
      emptyEl.classList.remove("hidden");
    }
  }

  loadTenant();
  loadMemorials();
</script>
</body>
</html>
