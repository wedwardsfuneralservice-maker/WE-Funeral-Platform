<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard – Funeral Console</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
  <!-- TRIAL BANNER -->
<div id="trialBanner" class="hidden w-full bg-amber-500/20 border-b border-amber-400/40 text-amber-200 text-sm text-center py-2">
  <span id="trialBannerText">Loading trial status...</span>
  <a id="trialUpgradeBtn"
     href="#"
     class="ml-2 underline font-semibold hover:text-amber-300">
     Upgrade Now
  </a>
</div>

<!-- EXPIRED TRIAL OVERLAY -->
<div id="trialExpiredOverlay"
     class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex flex-col items-center justify-center text-center p-6 z-[9999]">

  <h2 class="text-2xl font-bold text-red-300 mb-2">Your Free Trial Has Ended</h2>

  <p class="text-red-200 text-sm mb-6 max-w-sm">
    Your 14-day free trial has expired. To continue using the Admin Console and keep your funeral home site active, please upgrade your plan.
  </p>

  <a id="trialExpiredUpgrade"
     class="px-6 py-3 bg-amber-400 text-black font-semibold rounded-lg shadow hover:bg-amber-300 transition">
     Upgrade Plan
  </a>
</div>

<body class="min-h-screen bg-slate-950 text-slate-100">
  <div class="min-h-screen flex">
    <!-- SIDEBAR -->
    <aside class="w-60 bg-slate-950 border-r border-slate-900 flex flex-col">
      <div class="px-4 py-4 border-b border-slate-900">
        <div class="flex items-center space-x-2">
          <div class="w-8 h-8 rounded-full bg-gradient-to-br from-amber-400 to-rose-500 shadow-md"></div>
          <div>
            <div class="text-xs uppercase tracking-[0.25em] text-amber-200/80">W.E Console</div>
            <div id="tenantName" class="text-xs text-slate-300 truncate">Tenant</div>
          </div>
        </div>
      </div>
      <nav class="flex-1 px-2 py-3 text-xs space-y-1">
        <a href="#" data-page="overview" class="nav-link flex items-center px-3 py-2 rounded-xl bg-slate-900 text-amber-200">
          Overview
        </a>
        <a href="#" data-page="memorials" class="nav-link flex items-center px-3 py-2 rounded-xl text-slate-300 hover:bg-slate-900">
          Memorials
        </a>
        <a href="#" data-page="pdf" class="nav-link flex items-center px-3 py-2 rounded-xl text-slate-300 hover:bg-slate-900">
          PDF Auto-fill
        </a>
        <a href="#" data-page="scheduler" class="nav-link flex items-center px-3 py-2 rounded-xl text-slate-300 hover:bg-slate-900">
          Appointment Scheduler
        </a>
        <a href="#" data-page="accounting" class="nav-link flex items-center px-3 py-2 rounded-xl text-slate-300 hover:bg-slate-900">
          Accounting
        </a>
        <a href="#" data-page="designer" class="nav-link flex items-center px-3 py-2 rounded-xl text-slate-300 hover:bg-slate-900">
          Drag &amp; Drop Designer
        </a>
      </nav>
      <div class="px-4 py-3 border-t border-slate-900 text-[0.7rem] text-slate-500">
        <button id="logoutBtn" class="underline underline-offset-2">Log out</button>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="flex-1">
      <!-- TOP BAR -->
      <header class="border-b border-slate-900 bg-slate-950/80 backdrop-blur">
        <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
          <div>
            <h1 id="pageTitle" class="text-sm font-semibold text-slate-50">Overview</h1>
            <p class="text-[0.7rem] text-slate-400">Multi-tenant funeral admin console</p>
          </div>
          <a id="publicLink" href="#" class="text-[0.7rem] px-3 py-1.5 rounded-full border border-slate-700 text-slate-200 hover:bg-slate-800">
            View public site
          </a>
        </div>
      </header>

      <!-- OVERVIEW PAGE -->
      <section id="page-overview" class="max-w-6xl mx-auto px-4 py-6 text-xs">
        <div class="grid gap-3 sm:grid-cols-3 mb-4">
          <div class="card">
            <div class="text-[0.65rem] text-slate-400 uppercase tracking-wide mb-1">Memorials</div>
            <div id="statMemorials" class="text-xl font-semibold">0</div>
          </div>
          <div class="card">
            <div class="text-[0.65rem] text-slate-400 uppercase tracking-wide mb-1">Appointments</div>
            <div id="statAppointments" class="text-xl font-semibold">0</div>
          </div>
          <div class="card">
            <div class="text-[0.65rem] text-slate-400 uppercase tracking-wide mb-1">Invoices</div>
            <div id="statInvoices" class="text-xl font-semibold">0</div>
          </div>
        </div>
        <p class="text-[0.7rem] text-slate-400">
          This starter dashboard gives you a high-level view. The other tabs let you manage data for this funeral home.
        </p>
      </section>

      <!-- MEMORIALS PAGE (NEW CARD LAYOUT) -->
      <section id="page-memorials" class="max-w-6xl mx-auto px-4 py-6 text-xs hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-sm font-semibold text-slate-50">Memorials</h2>
          <p class="text-[0.7rem] text-slate-400">Create and manage online memorials for this funeral home.</p>
        </div>

        <!-- Add Memorial card -->
        <div class="card mb-6">
          <h3 class="text-[0.75rem] font-semibold text-slate-100 mb-3">Add new memorial</h3>
          <form id="memorialForm" class="space-y-4">
            <!-- Personal section -->
            <div class="grid gap-3 md:grid-cols-2">
              <div class="md:col-span-2">
                <label class="label">Full name</label>
                <input name="fullName" class="input" required />
              </div>
              <div>
                <label class="label">Date of birth</label>
                <input name="dob" class="input" placeholder="YYYY-MM-DD" />
              </div>
              <div>
                <label class="label">Date of death</label>
                <input name="dod" class="input" placeholder="YYYY-MM-DD" />
              </div>
            </div>

            <!-- Obituary / Summary -->
            <div class="grid gap-3 md:grid-cols-[2fr,1fr]">
              <div>
                <label class="label">Obituary / life story</label>
                <textarea name="obituary" rows="4" class="input resize-y" placeholder="Write the obituary or life story here..."></textarea>
              </div>
              <div>
                <label class="label">Short summary (optional)</label>
                <textarea name="summary" rows="4" class="input resize-y" placeholder="For preview cards on the website."></textarea>
              </div>
            </div>

            <!-- Viewing + Service -->
            <div class="grid gap-4 md:grid-cols-2">
              <div class="space-y-3">
                <p class="section-heading">Viewing</p>
                <div class="grid gap-3 md:grid-cols-2">
                  <div>
                    <label class="label">Viewing date</label>
                    <input name="viewingDate" class="input" placeholder="YYYY-MM-DD" />
                  </div>
                  <div>
                    <label class="label">Viewing time</label>
                    <input name="viewingTime" class="input" placeholder="e.g. 4:00 PM" />
                  </div>
                </div>
                <div>
                  <label class="label">Viewing location</label>
                  <input name="viewingLocation" class="input" placeholder="Funeral home / chapel" />
                </div>
              </div>

              <div class="space-y-3">
                <p class="section-heading">Funeral service</p>
                <div class="grid gap-3 md:grid-cols-2">
                  <div>
                    <label class="label">Service date</label>
                    <input name="serviceDate" class="input" placeholder="YYYY-MM-DD" />
                  </div>
                  <div>
                    <label class="label">Service time</label>
                    <input name="serviceTime" class="input" placeholder="e.g. 10:00 AM" />
                  </div>
                </div>
                <div>
                  <label class="label">Service location</label>
                  <input name="serviceLocation" class="input" placeholder="Church / chapel" />
                </div>
                <div>
                  <label class="label">Livestream link (optional)</label>
                  <input name="livestreamLink" class="input" placeholder="YouTube / Facebook / Zoom URL" />
                </div>
              </div>
            </div>

            <!-- Burial + Photo -->
            <div class="grid gap-4 md:grid-cols-[2fr,1fr]">
              <div class="space-y-3">
                <p class="section-heading">Burial / interment</p>
                <div class="grid gap-3 md:grid-cols-2">
                  <div>
                    <label class="label">Burial date</label>
                    <input name="burialDate" class="input" placeholder="YYYY-MM-DD (optional)" />
                  </div>
                  <div>
                    <label class="label">Burial time</label>
                    <input name="burialTime" class="input" placeholder="e.g. 2:00 PM (optional)" />
                  </div>
                </div>
                <div>
                  <label class="label">Place of burial</label>
                  <input name="burialPlace" class="input" placeholder="Cemetery / burial ground" />
                </div>
              </div>

              <div class="space-y-3">
                <p class="section-heading">Main photo</p>
                <p class="text-[0.7rem] text-slate-400">
                  Upload the primary portrait for this memorial (JPG or PNG). This will appear on the public memorial card.
                </p>
                <input type="file" name="photo" class="text-[0.7rem] text-slate-300" />
              </div>
            </div>

            <div class="pt-2 flex justify-end">
              <button
                class="px-4 py-2 rounded-xl bg-amber-400 text-slate-950 text-xs font-semibold hover:bg-amber-300 transition">
                Save memorial
              </button>
            </div>
          </form>
        </div>

        <!-- Existing memorials -->
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-[0.8rem] font-semibold text-slate-100">Existing memorials</h3>
          <span id="memorialCountLabel" class="text-[0.7rem] text-slate-400"></span>
        </div>
        <div id="memorialList" class="grid gap-3 md:grid-cols-2"></div>
      </section>

      <!-- PDF PAGE -->
      <section id="page-pdf" class="max-w-6xl mx-auto px-4 py-6 text-xs hidden">
        <h2 class="text-sm font-semibold text-slate-50 mb-3">PDF Auto-fill (Funeral Form)</h2>
        <p class="text-[0.7rem] text-slate-400 mb-3">
          This starter takes basic funeral form data and generates a simple PDF summary
          stored in the <code>/uploads/pdf</code> folder.
        </p>
        <form id="pdfForm" class="grid gap-3 sm:grid-cols-2 mb-3">
          <input name="deceasedName" placeholder="Deceased name" class="input" />
          <input name="refNumber" placeholder="Form reference number" class="input" />
          <input name="serviceDate" placeholder="Service date" class="input" />
          <input name="serviceTime" placeholder="Service time" class="input" />
          <input name="serviceLocation" placeholder="Service location" class="input sm:col-span-2" />
          <button class="sm:col-span-2 px-3 py-2 rounded-xl bg-amber-400 text-slate-950 text-xs font-medium hover:bg-amber-300">
            Generate PDF
          </button>
        </form>
        <div id="pdfResult" class="text-[0.7rem] text-slate-300"></div>
      </section>

      <!-- SCHEDULER PAGE -->
      <section id="page-scheduler" class="max-w-6xl mx-auto px-4 py-6 text-xs hidden">
        <h2 class="text-sm font-semibold text-slate-50 mb-3">Appointment Scheduler (Starter)</h2>
        <form id="apptForm" class="grid gap-3 sm:grid-cols-2 mb-4">
          <input name="title" placeholder="Meeting type (Arrangement, Follow-up…)" class="input sm:col-span-2" />
          <input name="clientName" placeholder="Client name" class="input" />
          <input name="date" placeholder="Date" class="input" />
          <input name="time" placeholder="Time" class="input" />
          <input name="location" placeholder="Location" class="input sm:col-span-2" />
          <input name="notes" placeholder="Notes" class="input sm:col-span-2" />
          <button class="sm:col-span-2 px-3 py-2 rounded-xl bg-amber-400 text-slate-950 text-xs font-medium hover:bg-amber-300">
            Add appointment
          </button>
        </form>
        <div id="apptList" class="space-y-2"></div>
      </section>

      <!-- ACCOUNTING PAGE -->
      <section id="page-accounting" class="max-w-6xl mx-auto px-4 py-6 text-xs hidden">
        <h2 class="text-sm font-semibold text-slate-50 mb-3">Accounting (Starter)</h2>
        <form id="invoiceForm" class="grid gap-3 sm:grid-cols-2 mb-4">
          <input name="invoiceNumber" placeholder="Invoice number" class="input" />
          <input name="clientName" placeholder="Client name" class="input" />
          <input name="amount" type="number" step="0.01" placeholder="Amount" class="input" />
          <input name="status" placeholder="Status (Unpaid/Paid…)" class="input" />
          <input name="dueDate" placeholder="Due date" class="input sm:col-span-2" />
          <input name="notes" placeholder="Notes" class="input sm:col-span-2" />
          <button class="sm:col-span-2 px-3 py-2 rounded-xl bg-amber-400 text-slate-950 text-xs font-medium hover:bg-amber-300">
            Add invoice
          </button>
        </form>
        <div id="invoiceList" class="space-y-2"></div>
      </section>

      <!-- DESIGNER PAGE -->
      <section id="page-designer" class="max-w-6xl mx-auto px-4 py-6 text-xs hidden">
        <h2 class="text-sm font-semibold text-slate-50 mb-3">Drag &amp; Drop Designer (Starter)</h2>
        <p class="text-[0.7rem] text-slate-400 mb-3">
          This starter gives you a basic drag-and-drop canvas where you can arrange blocks.
          In a future step we can save this layout to JSON and connect it to the live public page.
        </p>
        <div class="grid gap-4 md:grid-cols-[220px,1fr]">
          <div class="card space-y-2 text-[0.7rem]">
            <div class="font-semibold text-slate-200 mb-1">Blocks</div>
            <div class="block-pill" draggable="true" data-type="hero">Hero banner</div>
            <div class="block-pill" draggable="true" data-type="memorials">Memorial grid</div>
            <div class="block-pill" draggable="true" data-type="cta">Call to action</div>
          </div>
          <div id="designerCanvas" class="rounded-2xl bg-slate-900 border border-dashed border-slate-700 p-4 text-[0.75rem] min-h-[220px]">
            <p class="text-slate-500 mb-2">Drag blocks here to design your home page layout.</p>
          </div>
        </div>
      </section>
    </main>
  </div>

  <style>
    .input {
      width: 100%;
      border-radius: 0.75rem;
      background-color: #020617; /* slate-950 */
      border: 1px solid #1f2937; /* slate-700 */
      padding: 0.5rem 0.75rem;
      font-size: 0.75rem;
      color: #e5e7eb;
    }
    .input:focus {
      outline: none;
      border-color: #fbbf24;
      box-shadow: 0 0 0 1px rgba(251, 191, 36, 0.6);
    }
    .label {
      display: block;
      font-size: 0.7rem;
      color: #cbd5f5;
      margin-bottom: 0.15rem;
    }
    .section-heading {
      font-size: 0.7rem;
      font-weight: 600;
      color: #e5e7eb;
    }
    .card {
      border-radius: 1.25rem;
      background-color: #020617;
      border: 1px solid #1e293b;
      padding: 1rem;
    }
    .block-pill {
      border-radius: 0.75rem;
      background-color: #0f172a;
      border: 1px solid #1f2937;
      padding: 0.5rem 0.75rem;
      color: #e5e7eb;
      font-size: 0.75rem;
      cursor: move;
    }
    .block-pill:hover {
      background-color: #111827;
    }
  </style>

  <script>
    function getTenantFromQuery() {
      const url = new URL(window.location.href);
      return url.searchParams.get("tenant") || localStorage.getItem("we_admin_tenant") || "w-edwards";
    }

    const tenantSlug = getTenantFromQuery();

    if (localStorage.getItem("we_admin_logged_in") !== "true") {
      window.location.href = `/admin/admin-login.html?tenant=${encodeURIComponent(tenantSlug)}`;
    }

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("we_admin_logged_in");
      localStorage.removeItem("we_admin_tenant");
      window.location.href = "/";
    });

    const navLinks = document.querySelectorAll(".nav-link");
    const pages = {
      overview: document.getElementById("page-overview"),
      memorials: document.getElementById("page-memorials"),
      pdf: document.getElementById("page-pdf"),
      scheduler: document.getElementById("page-scheduler"),
      accounting: document.getElementById("page-accounting"),
      designer: document.getElementById("page-designer"),
    };
// ================================
// TRIAL STATUS LOADER
// ================================
async function loadTrialStatus() {
  try {
    const params = new URLSearchParams(window.location.search);
    const tenantSlug = params.get("tenant");

    const res = await fetch(`/api/tenant/${tenantSlug}/status`);
    if (!res.ok) return;

    const data = await res.json();
    const banner = document.getElementById("trialBanner");
    const bannerText = document.getElementById("trialBannerText");
    const bannerUpgrade = document.getElementById("trialUpgradeBtn");

    const expiredOverlay = document.getElementById("trialExpiredOverlay");
    const expiredUpgrade = document.getElementById("trialExpiredUpgrade");

    // Setup upgrade link
    bannerUpgrade.href = `/billing.html?tenant=${tenantSlug}`;
    expiredUpgrade.href = `/billing.html?tenant=${tenantSlug}`;

    // Handle expired trial
    if (data.trialExpired && data.status !== "active") {
      expiredOverlay.classList.remove("hidden");
      return; // Stop further dashboard usage
    }

    // Show banner with days left
    const daysLeft = Math.ceil(
      (data.trialEndsAt - Date.now()) / (1000 * 60 * 60 * 24)
    );

    if (daysLeft <= 3) {
      // WARNING MODE (Red)
      banner.classList.remove("hidden");
      banner.classList.remove("bg-amber-500/20");
      banner.classList.add("bg-red-500/20", "border-red-400/40", "text-red-200");
      bannerText.textContent = `Your free trial expires in ${daysLeft} day(s)`;
    } else {
      // NORMAL MODE (Amber)
      banner.classList.remove("hidden");
      bannerText.textContent = `Free trial: ${daysLeft} days remaining`;
    }

  } catch (err) {
    console.error("Trial status error:", err);
  }
}

// Run trial checker when dashboard loads
loadTrialStatus();

    // ================================
// BLOCK DASHBOARD IF TRIAL EXPIRED
// ================================
function disableDashboardForExpiredTrial() {
  const overlay = document.getElementById("trialExpiredOverlay");
  if (!overlay.classList.contains("hidden")) {
    document.querySelectorAll("button, a").forEach(el => {
      if (!el.closest("#trialExpiredOverlay")) {
        el.style.pointerEvents = "none";
        el.style.opacity = "0.4";
      }
    });
  }
}

// Re-check every second (slight delay for UI)
setInterval(disableDashboardForExpiredTrial, 1000);

    function showPage(key) {
      Object.values(pages).forEach(sec => sec.classList.add("hidden"));
      pages[key].classList.remove("hidden");
      document.getElementById("pageTitle").textContent = key.charAt(0).toUpperCase() + key.slice(1);
      navLinks.forEach(link => {
        if (link.dataset.page === key) {
          link.classList.add("bg-slate-900", "text-amber-200");
          link.classList.remove("text-slate-300");
        } else {
          link.classList.remove("bg-slate-900", "text-amber-200");
          link.classList.add("text-slate-300");
        }
      });
    }

    navLinks.forEach(link => {
      link.addEventListener("click", (e) => {
        e.preventDefault();
        showPage(link.dataset.page);
      });
    });

    document.getElementById("publicLink").href = `/t/${tenantSlug}`;

    async function loadOverview() {
      try {
        const res = await fetch(`/api/${tenantSlug}/admin/overview`);
        const data = await res.json();
        document.getElementById("statMemorials").textContent = data.memorialCount ?? 0;
        document.getElementById("statAppointments").textContent = data.appointmentCount ?? 0;
        document.getElementById("statInvoices").textContent = data.invoiceCount ?? 0;
      } catch (err) {
        console.error(err);
      }
    }

    async function hydrateTenantName() {
      try {
        const res = await fetch("/api/tenants");
        const tenants = await res.json();
        const t = tenants.find(x => x.slug === tenantSlug);
        if (!t) return;
        const el = document.getElementById("tenantName");
        if (el) el.textContent = t.name;
      } catch (err) {
        console.error(err);
      }
    }

    // MEMORIALS
    const memorialForm = document.getElementById("memorialForm");
    const memorialListEl = document.getElementById("memorialList");
    const memorialCountLabel = document.getElementById("memorialCountLabel");

    async function loadMemorials() {
      try {
        const res = await fetch(`/api/${tenantSlug}/admin/memorials`);
        const list = await res.json();
        if (!Array.isArray(list) || list.length === 0) {
          memorialListEl.innerHTML = '<p class="text-[0.7rem] text-slate-500 col-span-2">No memorials yet.</p>';
          if (memorialCountLabel) memorialCountLabel.textContent = "0 memorials";
          return;
        }
        if (memorialCountLabel) memorialCountLabel.textContent = `${list.length} memorial${list.length === 1 ? "" : "s"}`;

        memorialListEl.innerHTML = list.map(m => `
          <article class="card flex flex-col justify-between">
            <div>
              <div class="flex items-center justify-between mb-1">
                <h4 class="text-[0.8rem] font-semibold text-slate-100">${m.fullName || "Unnamed"}</h4>
                <span class="text-[0.65rem] text-slate-500">${m.id}</span>
              </div>
              <p class="text-[0.7rem] text-slate-400 mb-1">
                ${m.serviceDate || ""} ${m.serviceTime ? "· " + m.serviceTime : ""} ${m.serviceLocation ? "· " + m.serviceLocation : ""}
              </p>
              ${m.burialPlace ? `<p class="text-[0.7rem] text-slate-400 mb-1">Burial: ${m.burialPlace}</p>` : ""}
              ${m.livestreamLink ? `<p class="text-[0.7rem] text-amber-300 truncate">Livestream: ${m.livestreamLink}</p>` : ""}
            </div>
          </article>
        `).join("");
      } catch (err) {
        console.error(err);
      }
    }

    memorialForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(memorialForm);
      try {
        const res = await fetch(`/api/${tenantSlug}/admin/memorials`, {
          method: "POST",
          body: formData
        });
        const data = await res.json();
        if (!res.ok) {
          alert(data.error || "Failed to save memorial");
          return;
        }
        memorialForm.reset();
        await loadMemorials();
        await loadOverview();
      } catch (err) {
        console.error(err);
        alert("Network error");
      }
    });

    // PDF
    const pdfForm = document.getElementById("pdfForm");
    const pdfResult = document.getElementById("pdfResult");
    pdfForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const payload = Object.fromEntries(new FormData(pdfForm).entries());
      try {
        const res = await fetch(`/api/${tenantSlug}/admin/pdf/from-form`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) {
          pdfResult.textContent = data.error || "Failed to generate PDF.";
          return;
        }
        pdfResult.innerHTML = `PDF generated: <a class="text-amber-300 underline" href="${data.url}" target="_blank">Download</a>`;
      } catch (err) {
        console.error(err);
        pdfResult.textContent = "Network error.";
      }
    });

    // Scheduler
    const apptForm = document.getElementById("apptForm");
    const apptList = document.getElementById("apptList");
    async function loadAppointments() {
      try {
        const res = await fetch(`/api/${tenantSlug}/admin/appointments`);
        const list = await res.json();
        if (!Array.isArray(list) || list.length === 0) {
          apptList.innerHTML = '<p class="text-[0.7rem] text-slate-500">No appointments yet.</p>';
          return;
        }
        apptList.innerHTML = list.map(a => `
          <div class="card flex items-center justify-between">
            <div>
              <div class="text-[0.75rem] text-slate-100">${a.title || "Appointment"}</div>
              <div class="text-[0.65rem] text-slate-400">${a.date || ""} · ${a.time || ""}</div>
              <div class="text-[0.65rem] text-slate-500">${a.clientName || ""}</div>
            </div>
          </div>
        `).join("");
      } catch (err) {
        console.error(err);
      }
    }

    apptForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const payload = Object.fromEntries(new FormData(apptForm).entries());
      try {
        const res = await fetch(`/api/${tenantSlug}/admin/appointments`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) {
          alert(data.error || "Failed to save appointment");
          return;
        }
        apptForm.reset();
        await loadAppointments();
        await loadOverview();
      } catch (err) {
        console.error(err);
        alert("Network error");
      }
    });

    // Accounting
    const invoiceForm = document.getElementById("invoiceForm");
    const invoiceList = document.getElementById("invoiceList");
    async function loadInvoices() {
      try {
        const res = await fetch(`/api/${tenantSlug}/admin/accounting/invoices`);
        const list = await res.json();
        if (!Array.isArray(list) || list.length === 0) {
          invoiceList.innerHTML = '<p class="text-[0.7rem] text-slate-500">No invoices yet.</p>';
          return;
        }
        invoiceList.innerHTML = list.map(inv => `
          <div class="card flex items-center justify-between">
            <div>
              <div class="text-[0.75rem] text-slate-100">${inv.invoiceNumber || "Invoice"}</div>
              <div class="text-[0.65rem] text-slate-400">${inv.clientName || ""}</div>
            </div>
            <div class="text-right">
              <div class="text-[0.75rem] text-slate-100">$${inv.amount?.toFixed ? inv.amount.toFixed(2) : inv.amount}</div>
              <div class="text-[0.65rem] text-slate-400">${inv.status || ""}</div>
            </div>
          </div>
        `).join("");
      } catch (err) {
        console.error(err);
      }
    }

    invoiceForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const payload = Object.fromEntries(new FormData(invoiceForm).entries());
      try {
        const res = await fetch(`/api/${tenantSlug}/admin/accounting/invoices`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) {
          alert(data.error || "Failed to save invoice");
          return;
        }
        invoiceForm.reset();
        await loadInvoices();
        await loadOverview();
      } catch (err) {
        console.error(err);
        alert("Network error");
      }
    });

    // Designer drag-and-drop
    const blocks = document.querySelectorAll(".block-pill");
    const canvas = document.getElementById("designerCanvas");
    blocks.forEach(block => {
      block.addEventListener("dragstart", (e) => {
        e.dataTransfer.setData("text/plain", block.dataset.type);
      });
    });
    canvas.addEventListener("dragover", (e) => {
      e.preventDefault();
      canvas.classList.add("border-amber-400");
    });
    canvas.addEventListener("dragleave", () => {
      canvas.classList.remove("border-amber-400");
    });
    canvas.addEventListener("drop", (e) => {
      e.preventDefault();
      canvas.classList.remove("border-amber-400");
      const type = e.dataTransfer.getData("text/plain");
      const div = document.createElement("div");
      div.className = "rounded-xl bg-slate-800 border border-slate-700 px-3 py-2 mb-2";
      div.textContent = "Block: " + type;
      canvas.appendChild(div);
    });

    // Init
    showPage("overview");
    loadOverview();
    hydrateTenantName();
    loadMemorials();
    loadAppointments();
    loadInvoices();
  </script>
</body>
</html>
