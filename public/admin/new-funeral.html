
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Create New Funeral Record ‚Äì W.E. Funeral Service Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ========================================= -->
  <!-- ADMIN THEME (MATCHES SUPER ADMIN EXACTLY) -->
  <!-- ========================================= -->
  <style>
    :root {
      --blue: #306cde;
      --blue-soft: rgba(48, 108, 222, 0.13);
      --gold: #f5c242;

      --bg-main-dark: #0d0f12;
      --bg-elevated-dark: #171a22;
      --text-primary-dark: #f9fafb;
      --text-muted-dark: #9ca3af;
      --border-subtle-dark: rgba(148, 163, 184, 0.18);

      --bg-main-light: #f8fafc;
      --bg-elevated-light: #ffffff;
      --text-primary-light: #0f172a;
      --text-muted-light: #6b7280;
      --border-subtle-light: rgba(148, 163, 184, 0.35);

      --radius-lg: 16px;
      --radius-md: 10px;
      --shadow-soft: 0 18px 35px rgba(0, 0, 0, 0.45);
    }

    /* BODY THEMES --------------------------------------- */
    body.theme-dark {
      margin: 0;
      font-family: system-ui, sans-serif;
      color: var(--text-primary-dark);
      background:
        radial-gradient(circle at top left, var(--blue-soft), transparent 60%),
        radial-gradient(circle at bottom right, rgba(15, 23, 42, 0.9), #020617);
      display: flex;
      min-height: 100vh;
    }

    body.theme-light {
      margin: 0;
      font-family: system-ui, sans-serif;
      color: var(--text-primary-light);
      background: var(--bg-main-light);
      display: flex;
      min-height: 100vh;
    }

    /* LAYOUT WRAPPER ------------------------------------- */
    .shell {
      display: flex;
      width: 100%;
    }

    /* SIDEBAR -------------------------------------------- */
    .sidebar {
      width: 260px;
      padding: 24px 20px;
      display: flex;
      flex-direction: column;
      gap: 28px;
      box-shadow: 18px 0 40px rgba(0, 0, 0, 0.45);
      z-index: 20;
    }

    body.theme-dark .sidebar {
      background: linear-gradient(180deg, #05060a, #0b0d12 40%, #05060a 100%);
      border-right: 1px solid rgba(148, 163, 184, 0.25);
    }

    body.theme-light .sidebar {
      background: #ffffff;
      border-right: 1px solid var(--border-subtle-light);
      box-shadow: 12px 0 30px rgba(15, 23, 42, 0.06);
    }

/* Multi-step visibility control */
.form-section, section {
  display: none;
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 0.35s ease, transform 0.35s ease;
}

.form-section.active-step, section.active-step {
  display: block;
  opacity: 1;
  transform: translateY(0);
}

/* Navigation buttons */
.step-nav {
  margin-top: 30px;
  display: flex;
  justify-content: space-between;
}

.step-btn {
  padding: 10px 18px;
  border-radius: 999px;
  font-size: 14px;
  cursor: pointer;
  border: none;
  transition: transform 0.15s ease;
}

.step-btn.primary {
  background: linear-gradient(90deg, var(--blue), #5b8bff);
  color: white;
  box-shadow: 0 10px 22px rgba(37, 99, 235, 0.45);
}

.step-btn.secondary {
  background: rgba(148,163,184,0.2);
  color: white;
}

.step-btn:active {
  transform: translateY(1px);
}


    /* SIDEBAR BRAND -------------------------------------- */
    .brand-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-title {
      font-size: 18px;
      letter-spacing: 0.14em;
      font-weight: 700;
      text-transform: uppercase;
      color: var(--gold);
    }

    .brand-sub {
      font-size: 12px;
      text-transform: uppercase;
      opacity: 0.75;
    }

    .nav-section-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-muted-dark);
      margin-bottom: 6px;
    }
    body.theme-light .nav-section-label {
      color: var(--text-muted-light);
    }

    .nav-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .nav-item {
      border-radius: 999px;
      padding: 8px 12px;
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 14px;
      cursor: pointer;
      border: 1px solid transparent;
      transition: background 0.18s ease, transform 0.12s ease;
    }

    body.theme-dark .nav-item {
      color: var(--text-muted-dark);
    }
    body.theme-light .nav-item {
      color: var(--text-muted-light);
    }

    .nav-item:hover {
      transform: translateX(2px);
    }

    body.theme-dark .nav-item:hover {
      background: rgba(15, 23, 42, 0.8);
      border-color: rgba(148, 163, 184, 0.3);
    }

    .nav-item.active {
      background: linear-gradient(90deg, var(--blue), #5b8bff);
      color: #fff;
      box-shadow: 0 0 0 1px rgba(147, 197, 253, 0.4);
    }

    /* MAIN AREA ------------------------------------------- */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 24px 28px;
      gap: 24px;
      box-sizing: border-box;
    }

    /* TOP BAR --------------------------------------------- */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .topbar-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .page-title {
      font-size: 26px;
      font-weight: 700;
    }

    .page-subtitle {
      font-size: 13px;
      opacity: 0.75;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .avatar-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 10px;
      border-radius: 99px;
      border: 1px solid rgba(148,163,184,0.4);
    }

    .avatar-circle {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, var(--gold), #4b5563);
    }

    /* CARD WRAPPER ---------------------------------------- */
    .content-card {
      border-radius: var(--radius-lg);
      padding: 26px 30px;
      box-sizing: border-box;
      margin-top: 10px;
    }

    body.theme-dark .content-card {
      background: radial-gradient(circle at top left, rgba(48,108,222,0.22), transparent 60%),
        linear-gradient(145deg, #0b1020, #111827);
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow: var(--shadow-soft);
    }

    body.theme-light .content-card {
      background: var(--bg-elevated-light);
      border: 1px solid var(--border-subtle-light);
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.08);
    }
.nok-card {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 14px;
    padding: 20px;
    margin-bottom: 24px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.35);
}

.nok-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 14px;
}

.priority-badge {
    background: rgba(48,108,222,0.2);
    padding: 6px 12px;
    border-radius: 10px;
    font-size: 14px;
    color: #fff;
}

.priority-controls button {
    background: rgba(255,255,255,0.2);
    border: none;
    padding: 4px 8px;
    margin-left: 4px;
    cursor: pointer;
    border-radius: 6px;
    color: #fff;
    font-size: 12px;
}

.nok-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0,1fr));
    gap: 16px 30px;
}

.id-preview,
.signature-preview {
    width: 90px;
    height: 90px;
    border-radius: 10px;
    object-fit: cover;
    margin-top: 6px;
    background: rgba(0,0,0,0.4);
}

.remove-nok {
    margin-top: 16px;
    background: #dc2626;
    color: white;
    padding: 6px 14px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
}
    <style>

/* =========================
   FORM LAYOUT CONTAINER
========================= */
.form-section {
  background: rgba(255,255,255,0.04);
  padding: 28px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.08);
  margin-bottom: 32px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.35);
}

/* Section Title */
.form-section h2 {
  font-size: 22px;
  margin-bottom: 6px;
}

/* Section subtitle */
.form-section p {
  font-size: 14px;
  opacity: 0.7;
  margin-bottom: 18px;
}

/* =========================
   CLASSIC TWO-COLUMN GRID
========================= */
.form-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 22px 28px;
  width: 85%;
  margin: auto;
}

@media (max-width: 900px) {
  .form-grid { grid-template-columns: 1fr; }
}

/* =========================
   LABEL CHIP STYLE
========================= */
.label-chip {
  display: inline-block;
  padding: 4px 10px;
  background: rgba(255,255,255,0.08);
  border-radius: 12px;
  font-size: 13px;
  margin-bottom: 6px;
  border: 1px solid rgba(255,255,255,0.15);
}

/* =========================
   INPUT FIELD STYLING
========================= */
/* Make fields shorter */
.form-input.short,
.form-select.short {
  width: 95%;
  padding: 10px 12px;
  background: white;
  color: #111;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #cbd5e1;
  outline: none;
}

.form-input:focus,
.form-select:focus {
  border-color: #306cde;
  box-shadow: 0 0 0 2px rgba(48,108,222,0.25);
}

/* =========================
   PORTRAIT + ID IMAGES
========================= */
/* Portrait center */
.photo-center {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

.portrait-wrapper {
  width: 160px;
  height: 160px;
  margin: 0 auto 10px;
  border-radius: 100%;
  border: 2px solid rgba(255,255,255,0.4);
  overflow: hidden;
  background: rgba(255,255,255,0.15);
}

.portrait-wrapper img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
/* Full-width rows (portrait & button) */
.full-row {
  grid-column: 1 / -1;
}

/* Small ID preview */
.small-id {
  width: 90px;
  height: 60px;
  border-radius: 6px;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.25);
  object-fit: cover;
}

/* =========================
   NEXT BUTTON ALIGNMENT
========================= */
.next-btn {
  background: #306CDE;
  padding: 12px 26px;
  font-size: 15px;
  border-radius: 10px;
  border: none;
  color: white;
  margin-top: 20px;
  cursor: pointer;
  float: right;
  box-shadow: 0 8px 20px rgba(48,108,222,0.4);
}

.next-btn:hover {
  background: #3e7cff;
}
</style>

</head>

<body class="theme-dark">

  <div class="shell">

    <!-- ============================= -->
    <!-- SIDEBAR (FUNERAL MANAGEMENT) -->
    <!-- ============================= -->
    <aside class="sidebar">

      <div class="brand-block">
        <div class="brand-title">W.E. FUNERAL</div>
        <div class="brand-sub">Service Console</div>
      </div>

      <div>
        <div class="nav-section-label">Funeral Management</div>
        <ul class="nav-list">
          <li class="nav-item active" data-target="section-deceased">üïäÔ∏è Deceased Information</li>
          <li class="nav-item" data-target="section-nok">üë• Next of Kin</li>
          <li class="nav-item" data-target="section-funeral-type">‚ö∞Ô∏è Funeral Type</li>
          <li class="nav-item" data-target="section-services">üìú Service & Burial / Cremation</li>
          <li class="nav-item" data-target="section-shipment">‚úàÔ∏è Shipment / Repatriation</li>
          <li class="nav-item" data-target="section-costs">üí≤ Costs & Payments</li>
          <li class="nav-item" data-target="section-documents">üìÑ Documents</li>
          <li class="nav-item" data-target="section-pdf">üßæ PDF Auto-Fill</li>
          <li class="nav-item" data-target="section-review">‚úÖ Review & Submit</li>
        </ul>
      </div>

      <div class="sidebar-footer">
        W.E. Funeral Platform ¬© <span id="yearSpan"></span>
      </div>

    </aside>

    <!-- ============================= -->
    <!-- MAIN AREA -->
    <!-- ============================= -->
    <main class="main">

      <!-- TOP BAR -->
      <header class="topbar">
        <div class="topbar-left">
          <div class="page-title">Create New Funeral Record</div>
          <div class="page-subtitle">Enter, review, and manage all funeral arrangement details.</div>
        </div>

        <div class="topbar-right">
          <div class="avatar-chip">
            <div class="avatar-circle"></div>
            <span>Admin</span>
          </div>
        </div>
      </header>

      <!-- MAIN CONTENT AREA (sections will be inserted next) -->
      <div id="contentArea">
        <!-- PART A ‚Äî 2/2 will continue from here -->
<!-- ===================================================== -->
<!-- FUNERAL FORM SECTIONS (STRUCTURE ONLY FOR NOW)        -->
<!-- ===================================================== -->

<!-- SECTION 1 ‚Äî DECEASED INFORMATION -->
    <!-- Form fields added in PART B -->

 <div class="form-section" id="section-deceased">

  <h2>üïäÔ∏è Deceased Information</h2>
  <p>Enter full legal and identification information for the deceased.</p>

  <div class="form-grid">

    <!-- CENTERED PORTRAIT -->
    <div class="full-row photo-center">
      <div class="portrait-wrapper">
        <img id="portraitPreview" src="" alt="">
      </div>
      <div class="label-chip">Portrait Photo</div>
      <input type="file" onchange="previewImage(this,'portraitPreview')" />
    </div>

    <!-- Reference + Director -->
    <div>
      <div class="label-chip">Reference Number</div>
      <input id="refNumber" class="form-input short" readonly />
    </div>

    <div>
      <div class="label-chip">Responsible Funeral Director</div>
      <select id="funeralDirector" class="form-select short">
        <option>Select‚Ä¶</option>
        <option>Carl Brathwaite</option>
        <option>Winston Edwards</option>
      </select>
    </div>

    <!-- ID Images -->
    <div>
      <div class="label-chip">ID Front</div>
      <img id="idFrontPreview" class="small-id" />
      <input type="file" onchange="previewImage(this,'idFrontPreview')" />
    </div>

    <div>
      <div class="label-chip">ID Back</div>
      <img id="idBackPreview" class="small-id" />
      <input type="file" onchange="previewImage(this,'idBackPreview')" />
    </div>

    <!-- Full Name + Alias -->
    <div>
      <div class="label-chip">Full Name</div>
      <input id="fullName" class="form-input short" type="text" />
    </div>

    <div>
      <div class="label-chip">Alias / Other Names</div>
      <input id="alias" class="form-input short" type="text" />
    </div>

    <!-- Gender + Marital -->
    <div>
      <div class="label-chip">Gender</div>
      <select id="gender" class="form-select short">
        <option>Select‚Ä¶</option>
        <option>Male</option>
        <option>Female</option>
        <option>Other</option>
      </select>
    </div>

    <div>
      <div class="label-chip">Marital Status</div>
      <select id="maritalStatus" class="form-select short">
        <option>Select‚Ä¶</option>
        <option>Single</option>
        <option>Married</option>
        <option>Divorced</option>
        <option>Widowed</option>
      </select>
    </div>

    <!-- Date of Birth + Date of Death -->
    <div>
      <div class="label-chip">Date of Birth</div>
      <input id="dob" class="form-input short" type="date" onchange="calculateAge()" />
    </div>

    <div>
      <div class="label-chip">Date & Time of Death</div>
      <input id="dod" class="form-input short" type="datetime-local" onchange="calculateAge()" />
    </div>

    <!-- Age + Country -->
    <div>
      <div class="label-chip">Age</div>
      <input id="age" class="form-input short" readonly />
    </div>

    <div>
      <div class="label-chip">Country of Death</div>
      <select id="countryOfDeath" class="form-select short">
        <option>Barbados</option>
        <option>Trinidad & Tobago</option>
        <option>Jamaica</option>
        <option>United States</option>
      </select>
    </div>



  </div>
</div>
<!-- SECTION 2 ‚Äî NEXT OF KIN -->
<!-- ============================= -->
<!-- CO-PAYER TEMPLATE (No ID)     -->
<!-- ============================= -->



<!-- ===================================== -->
<!-- NOK TEMPLATE (ID front/back + signature) -->
<!-- ===================================== -->
<div id="nokTemplate" style="display:none;">

  <div class="nok-card">

    <h3 class="nok-title">Next of Kin</h3>

    <div class="nok-grid">

        <!-- Full Name -->
        <div>
            <label>Full Name *</label>
            <input type="text" name="nok_fullName[]" required>
        </div>

        <!-- Relationship -->
       <div class="relationship-wrapper">
    <label>Relationship *</label>
    <div class="relationship-row">
        <select name="nok_relationship[]" onchange="toggleOtherRelationship(this)" required>
            <option value="">Select‚Ä¶</option>
            <option>Spouse</option>
            <option>Child</option>
            <option>Parent</option>
            <option>Sibling</option>
            <option>Relative</option>
            <option>Friend</option>
            <option>Care-giver</option>
            <option value="other">Other</option>
        </select>

        <input
            type="text"
            class="other-input"
            name="nok_otherText[]"
            placeholder="Please specify‚Ä¶"
            style="display:none;"

        >
    </div>
</div>

        <!-- Phone -->
        <div>
            <label>Phone *</label>
            <input type="text" name="nok_phone[]" oninput="formatPhone(this)" required>
        </div>

        <!-- Email -->
        <div>
            <label>Email</label>
            <input type="email" name="nok_email[]">
        </div>

        <!-- Address -->
        <div>
            <label>Address</label>
            <input type="text" name="nok_address[]">
        </div>

        <!-- ID FRONT -->
        <div>
            <label>ID Card Front</label>
            <img class="small-id nok-id-front" />
            <input type="file" onchange="previewSiblingPreview(this, 'nok-id-front')">

        </div>

        <!-- ID BACK -->
        <div>
            <label>ID Card Back</label>
            <img class="small-id nok-id-back" />
  <input type="file" onchange="previewSiblingPreview(this, 'nok-id-back')">

        </div>

        <!-- SIGNATURE -->
        <div>
            <label>Electronic Signature</label>
            <img class="signature-preview nok-signature" />
  <input type="file" onchange="previewSiblingPreview(this, 'nok-signature')">

        </div>

    </div>

    <div style="margin-bottom:20px;">
    <label><strong>Is this person the primary payer?</strong></label>
   <select class="primary-payer-select" onchange="handlePayerSelection(this)">
        <option value="">Select‚Ä¶</option>
        <option value="yes">Yes</option>
        <option value="no">No</option>
        <option value="partial">Partial Payer</option>
    </select>
</div>

  <div id="copayerTemplate" style="display:none;">
  <div class="nok-card copayer-card">

      <h3 class="nok-title">Co-Payer</h3>

      <div class="nok-grid">

          <div>
              <label>Full Name *</label>
              <input type="text" name="copayer_fullName[]" required >
          </div>

          <!-- Relationship -->
         <div class="relationship-wrapper">
      <label>Relationship *</label>
      <div class="relationship-row">
          <select name="nok_relationship[]" onchange="toggleOtherRelationship(this)" required >
              <option value="">Select‚Ä¶</option>
              <option>Spouse</option>
              <option>Child</option>
              <option>Parent</option>
              <option>Sibling</option>
              <option>Relative</option>
              <option>Friend</option>
              <option>Care-giver</option>
              <option value="other">Other</option>
          </select>

          <input
              type="text"
              class="other-input"
              name="nok_otherText[]"
              placeholder="Please specify‚Ä¶"
              style="display:none;"

          >
      </div>
  </div>

          <div>
              <label>Phone *</label>
              <input type="text" name="copayer_phone[]" oninput="formatPhone(this)"required >
          </div>

          <div>
              <label>Email</label>
              <input type="email" name="copayer_email[]"required>
          </div>

          <div>
              <label>Address</label>
              <input type="text" name="copayer_address[]"required>
          </div>

      </div>

      <div style="margin-top:20px;">
      <label><strong>Is this person the primary payer?</strong></label>
     <select class="copayer-payer-select" onchange="handlePayerSelection(this)">
          <option value="">Select‚Ä¶</option>
      </select>
  </div>

      <button type="button" class="remove-nok" onclick="removeNok(this)">Remove</button>

  </div>
</div>

<div class="copayer-container"></div>

<button type="button"
        class="add-copayer-btn"
        style="display:none;"
        onclick="addCoPayerTo(this.closest('.nok-card'))">
    + Add Additional Co-Payer
</button>

  </div>


</div>



<section id="section-nok" class="content-card">
  <h2>Next of Kin</h2>
  <p class="section-description">
    List primary and secondary contact persons responsible for arrangements.
  </p>



<!-- Co-Payers container -->
<div id="copayerContainer"></div>

<!-- Button for partial payers -->
<button id="addCoPayerBtn" class="green-btn" style="display:none;" onclick="addCoPayer()">
    Ôºã Add Additional Co-Payer
</button>

<div id="nokContainer">
        <!-- NOK BLOCKS HERE (your existing layout stays the same) -->
    </div>

</section>

<!-- SECTION 3 ‚Äî FUNERAL TYPE -->
<section id="section-funeral-type" class="content-card">
  <h2>Funeral Type</h2>
  <p class="section-description">
    Select the funeral arrangement and automatically display relevant options.
  </p>

  <div class="section-placeholder">
    <em>Funeral Type form fields go here.</em>
  </div>
</section>

<!-- SECTION 4 ‚Äî SERVICE & BURIAL / CREMATION -->
<section id="section-services" class="content-card">
  <h2>Service, Burial & Cremation Details</h2>
  <p class="section-description">
    Add service details such as clergy, venue, cemetery, crematorium info, and timings.
  </p>
  <div class="section-placeholder">
    <em>Service & Burial fields will go here.</em>
  </div>
</section>

<!-- SECTION 5 ‚Äî SHIPMENT / REPATRIATION -->
<section id="section-shipment" class="content-card">
  <h2>Shipment / Repatriation Details</h2>
  <p class="section-description">
    Airline info, international funeral home details, consular data, etc.
  </p>
  <div class="section-placeholder">
    <em>Shipment & Repatriation fields will go here.</em>
  </div>
</section>

<!-- SECTION 6 ‚Äî COSTS & PAYMENTS -->
<section id="section-costs" class="content-card">
  <h2>Costs & Payments</h2>
  <p class="section-description">
    Itemize funeral expenses and calculate totals, deposits, and outstanding balances.
  </p>
  <div class="section-placeholder">
    <em>Costs & Payment fields will go here.</em>
  </div>
</section>

<!-- SECTION 7 ‚Äî DOCUMENTS -->
<section id="section-documents" class="content-card">
  <h2>Documents</h2>
  <p class="section-description">
    Upload ID cards, police reports, medical certificates, and supporting files.
  </p>
  <div class="section-placeholder">
    <em>Document upload fields go here.</em>
  </div>
</section>

<!-- SECTION 8 ‚Äî PDF AUTO-FILL -->
<section id="section-pdf" class="content-card">
  <h2>PDF Auto-Fill</h2>
  <p class="section-description">
    Select the government PDF form to automatically populate with funeral details.
  </p>
  <div class="section-placeholder">
    <em>PDF selection and preview will go here.</em>
  </div>
</section>

<!-- SECTION 9 ‚Äî REVIEW & SUBMIT -->
<section id="section-review" class="content-card">
  <h2>Review & Submit</h2>
  <p class="section-description">
    Final validation and submission of the complete funeral record.
  </p>
  <div class="section-placeholder">
    <em>Review summary goes here.</em>
  </div>
</section>


</div> <!-- END contentArea -->
</main> <!-- END main -->
</div> <!-- END shell -->

<!-- ========================================= -->
<!-- JAVASCRIPT ‚Äî ACTIVE STATE + SCROLL LOGIC -->
<!-- ========================================= -->
<script>
/* -------------------------
   YEAR AUTO-FILL
-------------------------- */
document.getElementById("yearSpan").textContent = new Date().getFullYear();

/* -------------------------
   SIDEBAR NAVIGATION
-------------------------- */
const navItems = document.querySelectorAll(".nav-item");

navItems.forEach(item => {
  item.addEventListener("click", () => {
    // Remove active from all
    navItems.forEach(i => i.classList.remove("active"));

    // Add active to clicked item
    item.classList.add("active");

    // Scroll to target section
    const target = item.getAttribute("data-target");
    const section = document.getElementById(target);

    if (section) {
      section.scrollIntoView({ behavior: "smooth", block: "start" });
    }
  });
});

/* --------------------------------------------------
   OBSERVER: HIGHLIGHT SIDEBAR item when scrolling
--------------------------------------------------- */
const observer = new IntersectionObserver((entries) => {
  entries.forEach(entry => {
    const id = entry.target.id;
    const navItem = document.querySelector(`.nav-item[data-target="${id}"]`);

    if (entry.isIntersecting) {
      navItems.forEach(i => i.classList.remove("active"));
      if (navItem) navItem.classList.add("active");
    }
  });
}, { threshold: 0.4 });

document.querySelectorAll("section").forEach(section => {
  observer.observe(section);
});
</script>
<script>
/* MULTI-STEP FUNCTIONALITY ---------------------------------- */

const sections = [
  "section-deceased",
  "section-nok",
  "section-funeral-type",
  "section-services",
  "section-shipment",
  "section-costs",
  "section-documents",
  "section-pdf",
  "section-review"
];

let currentStep = 0;

// Show first step on load
document.addEventListener("DOMContentLoaded", () => {
  showStep(0);
});

function showStep(index) {
  currentStep = index;

  sections.forEach((id, i) => {
    const section = document.getElementById(id);
    if (!section) return;

    if (i === index) {
      section.classList.add("active-step");
    } else {
      section.classList.remove("active-step");
    }
  });

  // Highlight sidebar
  document.querySelectorAll(".nav-item").forEach(item => {
    const target = item.getAttribute("data-target");
    item.classList.toggle("active", target === sections[index]);
  });

  // Inject buttons
  injectStepButtons(index);
}

function injectStepButtons(index) {
  const section = document.getElementById(sections[index]);

  // Remove existing nav row
  const existing = section.querySelector(".step-nav");
  if (existing) existing.remove();

  // Create new button row
  const nav = document.createElement("div");
  nav.className = "step-nav";

  // Back button
  if (index > 0) {
    const back = document.createElement("button");
    back.className = "step-btn secondary";
    back.textContent = "‚Üê Back";
    back.onclick = () => showStep(index - 1);
    nav.appendChild(back);
  } else {
    // Placeholder for layout alignment
    const spacer = document.createElement("div");
    nav.appendChild(spacer);
  }

  // Next button
  if (index < sections.length - 1) {
    const next = document.createElement("button");
    next.className = "step-btn primary";
    next.textContent = "Next ‚Üí";

    // SPECIAL HANDLING FOR NEXT OF KIN (section index = 1)
    if (index === 1) {
      next.onclick = () => {
        // Only NOK validation now ‚Äì payer logic is inside validateNokSection
        if (validateNokSection()) {
          showStep(index + 1);
        }
      };
    } else {
      next.onclick = () => showStep(index + 1);
    }

    nav.appendChild(next);


} else {

  const finish = document.createElement("button");
  finish.className = "step-btn primary";
  finish.textContent = "Submit Record";
  finish.onclick = () => alert("Submitting final funeral record‚Ä¶");
  nav.appendChild(finish);

}


  section.appendChild(nav);
}

/* SIDEBAR Integration: clicking navigates to step */
document.querySelectorAll(".nav-item").forEach((item, index) => {
  item.addEventListener("click", () => {
    showStep(index);
  });
});
</script>

<script>
/* ================================
   IMAGE PREVIEW HELPERS
================================ */
function previewImage(input, previewId) {
  const file = input.files && input.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = e => {
    const img = document.getElementById(previewId);
    if (img) img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

/* ================================
   AGE CALCULATION (DOD - DOB)
================================ */
function calculateAge() {
  const dobEl = document.getElementById("d_dob");
  const dodEl = document.getElementById("d_dod");
  const ageEl = document.getElementById("d_age");

  if (!dobEl || !dodEl || !ageEl) return;

  const dob = dobEl.value;
  const dod = dodEl.value;
  if (!dob || !dod) {
    ageEl.value = "";
    return;
  }

  const birth = new Date(dob);
  const death = new Date(dod);

  if (isNaN(birth.getTime()) || isNaN(death.getTime())) {
    ageEl.value = "";
    return;
  }

  let age = death.getFullYear() - birth.getFullYear();
  const m = death.getMonth() - birth.getMonth();
  if (m < 0 || (m === 0 && death.getDate() < birth.getDate())) {
    age--;
  }

  ageEl.value = age >= 0 ? age : "";
}

/* ================================
   MARITAL STATUS ‚Üí SPOUSE FIELD
================================ */
function toggleSpouseField() {
  const statusEl = document.getElementById("d_maritalStatus");
  const spouseField = document.getElementById("spouseField");
  if (!statusEl || !spouseField) return;

  const show = statusEl.value === "Married";
  spouseField.style.display = show ? "block" : "none";
}

/* ================================
   CERTIFICATE ISSUED ‚Üí NUMBER
================================ */
function toggleCertificateNumber() {
  const certEl = document.getElementById("d_certificateIssued");
  const certField = document.getElementById("certificateNumberField");
  if (!certEl || !certField) return;

  const show = certEl.value === "Yes";
  certField.style.display = show ? "block" : "none";
}

/* ================================
   COUNTRY LIST POPULATION
================================ */
const countries = [
  "Barbados","United States","United Kingdom","Canada","Jamaica",
  "Trinidad & Tobago","Guyana","Saint Lucia","Dominica","Grenada",
  "St. Vincent & the Grenadines","Antigua & Barbuda","St. Kitts & Nevis",
  "Bahamas","Belize","Suriname","France","Germany","Spain","Italy","Netherlands",
  "Brazil","Mexico","Nigeria","Ghana","South Africa","India","China","Australia",
  "New Zealand","Japan"
];

function loadCountriesIntoSelect(id) {
  const sel = document.getElementById(id);
  if (!sel) return;

  // Only populate if it's still on default state
  if (sel.options.length <= 1) {
    countries.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      sel.appendChild(opt);
    });
  }
}

function initCountries() {
  loadCountriesIntoSelect("d_countryOfDeath");
  loadCountriesIntoSelect("d_countryOfResidence");
}

/* ================================
   REFERENCE NUMBER GENERATOR
================================ */
function generateRefNumber() {
  const refEl = document.getElementById("d_refNumber");
  if (!refEl) return;

  if (!refEl.value) {
    const rand = Math.floor(100000 + Math.random() * 900000);
    refEl.value = "REF-" + rand;
  }
}

/* ================================
   INITIALIZE ON PAGE LOAD
================================ */
document.addEventListener("DOMContentLoaded", () => {
  initCountries();
  generateRefNumber();
});

  function previewImage(input, target) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => document.getElementById(target).src = e.target.result;
  reader.readAsDataURL(file);
}

function calculateAge() {
  const dob = new Date(document.getElementById("dob").value);
  const dod = new Date(document.getElementById("dod").value);

  if (!dob || !dod) return;

  let age = dod.getFullYear() - dob.getFullYear();
  const m = dod.getMonth() - dob.getMonth();

  if (m < 0 || (m === 0 && dod.getDate() < dob.getDate())) {
    age--;
  }

  document.getElementById("age").value = age + " years";

}

  document.addEventListener("DOMContentLoaded", () => {
  generateReferenceNumber();
});

document.addEventListener("DOMContentLoaded", () => {
  generateReferenceNumber();
});

function generateReferenceNumber() {
  const ref = "REF-" + Math.floor(100000 + Math.random() * 900000);
  document.getElementById("refNumber").value = ref;
}

  function formatPhone(input) {
    let v = input.value.replace(/\D/g, "");

    if (v.length >= 10) {
        input.value = `(${v.slice(0,3)}) ${v.slice(3,6)}-${v.slice(6,10)}`;
    } else {
        input.value = v;
    }
}

  let nokCount = 0;

document.addEventListener("DOMContentLoaded", () => {

    // Auto-create the first NOK card on page load
    const template = document.getElementById("nokTemplate");
    const container = document.getElementById("nokContainer");

    if (template && container && container.children.length === 0) {
        const clone = template.cloneNode(true);
        clone.style.display = "block"; // show first one
        clone.removeAttribute("id");   // prevent duplicate IDs
        clone.classList.add("nok-block");
        container.appendChild(clone);
    }

});
function toggleOtherRelationship(selectEl) {
    const wrapper = selectEl.closest(".relationship-row");
    if (!wrapper) return;

    const otherInput = wrapper.querySelector(".other-input");
    if (!otherInput) return;

    if (selectEl.value === "other") {
        otherInput.style.display = "inline-block";
        otherInput.required = true;
    } else {
        otherInput.style.display = "none";
        otherInput.required = false;
        otherInput.value = "";
    }
}

function addCoPayerTo(nokCard) {
    const template = document.getElementById("copayerTemplate");
    if (!template) return;

    const coContainer = nokCard.querySelector(".copayer-container");
    if (!coContainer) return;

    const clone = template.cloneNode(true);
    clone.style.display = "block";
    clone.removeAttribute("id");

    // Clear fields
    clone.querySelectorAll("input").forEach(i => i.value = "");

    // Fix remove button
    const removeBtn = clone.querySelector(".remove-nok");
    if (removeBtn) {
        removeBtn.onclick = () => removeNok(removeBtn);
    }

    // Fix payer dropdown
    const payerSel = clone.querySelector("select.copayer-payer-select");
    if (payerSel) {
        payerSel.onchange = () => handlePayerSelection(payerSel);
    }

    // Fix "Other" relationship dropdown
    const relSel = clone.querySelector(".relationship-row select");
    if (relSel) {
        relSel.onchange = () => toggleOtherRelationship(relSel);
    }

    coContainer.appendChild(clone);

    // Reconfigure dropdowns
    configureCoPayerDropdowns(nokCard);
}

  // DELETE the broken block ABOVE THIS LINE!

  function handlePayerSelection(sel) {
    const card = sel.closest(".nok-card") || sel.closest(".copayer-card");
    if (!card) return;

    const isCoPayer = card.classList.contains("copayer-card");

    // CASE 1 ‚Üí Inside a main NOK card (primary payer dropdown)
    if (!isCoPayer) {
        const mainNok = card;
        const coContainer = mainNok.querySelector(".copayer-container");
        const addBtn = mainNok.querySelector(".add-copayer-btn");

        if (!coContainer || !addBtn) return;

        const value = sel.value;

        if (value === "yes") {
            // Main NOK is full payer ‚Üí hide button, remove co-payers
            addBtn.style.display = "none";

            while (coContainer.firstChild) {
                coContainer.removeChild(coContainer.firstChild);
            }
        }

        else if (value === "no") {
            // Must have a co-payer card
            if (coContainer.children.length === 0) {
                addCoPayerTo(mainNok);
            }
            addBtn.style.display = "block";

            // First co-payer gets Yes/Partial; others get Partial only
            configureCoPayerDropdowns(mainNok);
        }

        else if (value === "partial") {
            // Similar to "no" but allows multiple partial payers
            if (coContainer.children.length === 0) {
                addCoPayerTo(mainNok);
            }
            addBtn.style.display = "block";
            configureCoPayerDropdowns(mainNok);
        }

        return;
    }

    // CASE 2 ‚Üí Inside a Co-Payer card
    if (isCoPayer) {
        const cpCard = card;
        const mainNok = cpCard.closest(".nok-card:not(.copayer-card)");
        if (!mainNok) return;

        const coContainer = mainNok.querySelector(".copayer-container");
        const addBtn = mainNok.querySelector(".add-copayer-btn");
        if (!coContainer || !addBtn) return;

        const coPayers = Array.from(coContainer.querySelectorAll(".copayer-card"));
        const index = coPayers.indexOf(cpCard);
        const value = sel.value;

        // FIRST co-payer
        if (index === 0) {
            if (value === "yes") {
                // First co-payer is full payer ‚Üí cannot have others
                addBtn.style.display = "none";

                // Remove all other co-payers
                for (let i = 1; i < coPayers.length; i++) {
                    coPayers[i].remove();
                }
            }

            else if (value === "partial") {
                addBtn.style.display = "block";

                // If this is the only co-payer ‚Üí auto-add next
                if (coPayers.length === 1) {
                    addCoPayerTo(mainNok);
                }

                configureCoPayerDropdowns(mainNok);
            }

            else {
                // Blank selection ‚Üí restore add button if needed
                addBtn.style.display = coPayers.length > 0 ? "block" : "none";
            }
        }

        // SECOND+ co-payers
        else {
            // Only partial payer allowed (your rules)
            addBtn.style.display = "block";
        }

        return;
    }
}


function configureCoPayerDropdowns(nokBlock) {
    const coContainer = nokBlock.querySelector(".copayer-container");
    if (!coContainer) return;

    const copayers = Array.from(coContainer.querySelectorAll(".copayer-card"));

    copayers.forEach((cp, index) => {
        const sel = cp.querySelector("select.copayer-payer-select");
        if (!sel) return;

        // Save current selection
        const current = sel.value;

        // Rebuild options
        sel.innerHTML = "";

        if (index === 0) {
            // FIRST Co-Payer: Yes + Partial
            sel.insertAdjacentHTML(
                "beforeend",
                '<option value="">Select‚Ä¶</option>' +
                '<option value="yes">Yes</option>' +
                '<option value="partial">Partial Payer</option>'
            );
        } else {
            // SECOND+ Co-Payers: Partial only
            sel.insertAdjacentHTML(
                "beforeend",
                '<option value="">Select‚Ä¶</option>' +
                '<option value="partial">Partial Payer</option>'
            );
        }

        // Restore value if still valid
        const validValues = ["yes", "partial", ""];
        if (validValues.includes(current)) {
            sel.value = current;
        }
    });
}



/* ================================
   NOK VALIDATION
   Rules:
   1) NOK required fields + payer = Yes  ‚Üí SUCCESS
   2) NOK required fields + payer = No/Partial
      AND all Co-Payer cards valid      ‚Üí SUCCESS
================================ */
function validateNokSection() {
  // Find the main NOK card (not a Co-Payer)
  const nok = document.querySelector("#nokContainer .nok-card:not(.copayer-card)");
  if (!nok) {
    alert("A Next of Kin entry is required.");
    return false;
  }

  // --- 1. Validate ONLY NOK's own required fields (not co-payers) ---
  const nokGrid = nok.querySelector(".nok-grid");
  if (!nokGrid) {
    alert("Internal layout error: NOK grid not found.");
    return false;
  }

  const nokRequired = nokGrid.querySelectorAll("input[required], select[required], textarea[required]");
  for (const f of nokRequired) {
    if (!f.value || !f.value.toString().trim()) {
      alert("Please complete all required fields for the Next of Kin.");
      f.scrollIntoView({ behavior: "smooth", block: "center" });
      f.focus();
      return false;
    }
  }

  // --- 2. Check NOK's primary payer selection ---
  const nokPayer = nok.querySelector(".primary-payer-select");
  if (!nokPayer || !nokPayer.value) {
    alert("Please select if the Next of Kin is the primary payer.");
    if (nokPayer) {
      nokPayer.scrollIntoView({ behavior: "smooth", block: "center" });
      nokPayer.focus();
    }
    return false;
  }

  const coContainer = nok.querySelector(".copayer-container");
  const coPayers = coContainer ? Array.from(coContainer.querySelectorAll(".copayer-card")) : [];

  // --------------------------------------------
  // CASE 1 ‚Üí NOK is full payer (YES)
  // --------------------------------------------
  if (nokPayer.value === "yes") {
    // Co-payers are optional and NOT required in this case
    return true;
  }

  // --------------------------------------------
  // CASE 2 ‚Üí NOK is NOT full payer (NO or PARTIAL)
  // ‚Üí Must have at least one valid Co-Payer
  // --------------------------------------------
  if (nokPayer.value === "no" || nokPayer.value === "partial") {
    if (coPayers.length === 0) {
      alert("This person is not the full payer. Please add at least one Co-Payer.");
      return false;
    }

    // Validate each co-payer block
    for (const cp of coPayers) {
      // Required co-payer fields (full name, relationship, phone, email, address)
      const cpRequired = cp.querySelectorAll("input[required], select[required], textarea[required]");

      for (const f of cpRequired) {
        if (!f.value || !f.value.toString().trim()) {
          alert("Please complete all required fields in the Co-Payer section.");
          f.scrollIntoView({ behavior: "smooth", block: "center" });
          f.focus();
          return false;
        }
      }

      // Co-payer's own payer status (Yes / Partial depending on position)
      const cpPayer = cp.querySelector(".copayer-payer-select");
      if (!cpPayer || !cpPayer.value) {
        alert("Each Co-Payer must have a payer status selected.");
        if (cpPayer) {
          cpPayer.scrollIntoView({ behavior: "smooth", block: "center" });
          cpPayer.focus();
        }
        return false;
      }
    }

    // All NOK + Co-Payers valid ‚Üí OK
    return true;
  }

  // Any other value would be unexpected
  alert("Unexpected payer selection. Please choose Yes, No, or Partial.");
  return false;
}

/* ---------------------------------
   Optional extra rule ‚Äì disabled
   (kept to avoid breaking references)
---------------------------------- */
function validatePayerConditions() {
  // Global rule turned off; all logic is in validateNokSection now.
  return true;
}


function removeNok(btn) {
  const card = btn.closest(".nok-card");
  if (!card) return;

  const parent = card.parentElement;
  const mainNok = parent.closest(".nok-card:not(.copayer-card)");

  card.remove();

  // If ALL co-payers removed ‚Üí show Add button again
  if (parent.classList.contains("copayer-container") && parent.children.length === 0) {
    const addBtn = mainNok ? mainNok.querySelector(".add-copayer-btn") : null;
    if (addBtn) addBtn.style.display = "block";
  }

  if (mainNok) {
    configureCoPayerDropdowns(mainNok);
  }
}

function previewSiblingPreview(input, className) {
    const file = input.files && input.files[0];
    if (!file) return;

    const img = input.closest("div").querySelector("." + className);
    if (!img) return;

    const reader = new FileReader();
    reader.onload = e => img.src = e.target.result;
    reader.readAsDataURL(file);
}


</script>
</body>
</html>
